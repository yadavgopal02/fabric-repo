name: Fabric UAT Migration

on:
  push:
    branches:
      - dev
  pull_request:
    types:
      - closed

jobs:
  create_pr_and_deploy_uat:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Open PR from dev to uat
        if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.PERSONAL_ACCESS_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls \
            -d '{
              "title": "Automated PR from dev to uat",
              "body": "Automatically generated pull request from dev to uat",
              "head": "dev",
              "base": "uat",
              "requested_reviewers": ["yadavgopal02"],
              "assignee": "yadavgopal02"
            }'

      - name: Add reviewer to PR
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        uses: actions/github-script@v5
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const response = await github.pulls.createReviewRequest({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              reviewers: ['yadavgopal02']
            });

            console.log(response);

      - name: Deploy to UAT after merge
        if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'uat'
        runs-on: ubuntu-latest
        steps:
          - name: Checkout repository
            uses: actions/checkout@v2

          - name: Azure Login
            env:
              AZURE_USERNAME: ${{ secrets.AZURE_USERNAME }}
              AZURE_PASSWORD: ${{ secrets.AZURE_PASSWORD }}
              ACTIONS_ALLOW_UNSECURE_COMMANDS: true
            run: |
              az login --username $AZURE_USERNAME --password $AZURE_PASSWORD
              
              echo "::set-env name=AZURE_ACCESS_TOKEN::$(az account get-access-token --resource 'https://api.fabric.microsoft.com' --query 'accessToken' -o tsv)"
              echo "Access Token: ${{ env.AZURE_ACCESS_TOKEN }}"

          - name: Print Access Token
            run: |
              echo "${{ steps.access_token.outputs.token }}"

          - name: Use Access Token in Workflow
            run: |
              echo "Access Token: ${{ env.AZURE_ACCESS_TOKEN }}"
          
          - name: Get changed files
            id: changed-files
            uses: tj-actions/changed-files@v33
          
          - name: Make API Call
            env:
              ID_TOKEN: ${{ secrets.MYID_TOKEN }}
              AZURE_ACCESS_TOKEN: ${{ env.AZURE_ACCESS_TOKEN }}
            run: |
              for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
                stackfile=$(echo $file | cut -f2 -d'/')
                parameter_value=$(cat deploy/$stackfile)
                curl --location 'https://api.fabric.microsoft.com/v1/workspaces/029ea194-7a2f-492e-8fa9-d1e471195c57/notebooks' \
                  --header 'Content-Type: application/json' \
                  --header 'Host: graph.microsoft.com' \
                  --header "Authorization: Bearer $AZURE_ACCESS_TOKEN" \
                  --data "$parameter_value"
              done
